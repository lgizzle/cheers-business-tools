{% extends "base.html" %}

{% block title %}Multi-Product Buying Calculator{% endblock %}

{% block additional_style %}
<style>
    /* Improve header legibility */
    .card-header.bg-light {
        background-color: #e9ecef !important;
        border-bottom: 1px solid #dee2e6;
    }

    .card-header.bg-light h4 {
        color: #212529;
        font-weight: 600;
    }

    /* Make table headers more readable */
    .thead-light th {
        background-color: #e9ecef !important;
        color: #212529;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }

    /* Section heading styles */
    .card .card-header {
        padding: 0.75rem 1.25rem;
    }

    /* Improve form label contrast */
    label {
        color: #212529;
        font-weight: 500;
    }

    /* Table header text */
    .table th {
        font-weight: 600;
        color: #212529;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="text-center mb-0">Multi-Product Buying Calculator</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12">
                    <p class="lead text-center">
                        Analyze the ROI of purchasing multiple related products at bulk discount pricing
                    </p>
                </div>
            </div>

            <!-- Parameters Section -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Parameters</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="smallDealMinimum">Small Deal Minimum</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="smallDealMinimum" min="1" value="30">
                                    <div class="input-group-append">
                                        <span class="input-group-text">cases</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="bulkDealMinimum">Bulk Deal Minimum</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="bulkDealMinimum" min="1" value="60">
                                    <div class="input-group-append">
                                        <span class="input-group-text">cases</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="paymentTerms">Payment Terms</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="paymentTerms" min="1" value="30">
                                    <div class="input-group-append">
                                        <span class="input-group-text">days</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scenario Management -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Scenario Management</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="scenarioName">Scenario Name</label>
                                <input type="text" class="form-control" id="scenarioName" placeholder="e.g., Cuervo Deal">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="scenarioSelect">Load Existing Scenario</label>
                                <select class="form-control" id="scenarioSelect">
                                    <option value="">-- Select Scenario --</option>
                                    <!-- Scenarios will be populated here -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="btn-group w-100">
                                <button class="btn btn-primary" id="saveScenario">Save Scenario</button>
                                <button class="btn btn-info" id="loadScenario">Load Scenario</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Products</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="productsTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Product Name</th>
                                    <th>Current Price</th>
                                    <th>Bulk Price</th>
                                    <th>Cases On Hand</th>
                                    <th>Cases/Year</th>
                                    <th>Bottles/Case</th>
                                    <th>Bulk Quantity</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be added here -->
                                <tr id="productRowTemplate" style="display:none;">
                                    <td><input type="text" class="form-control product-name"></td>
                                    <td><input type="number" class="form-control product-current-price" min="0" step="0.01"></td>
                                    <td><input type="number" class="form-control product-bulk-price" min="0" step="0.01"></td>
                                    <td><input type="number" class="form-control product-cases-on-hand" min="0"></td>
                                    <td><input type="number" class="form-control product-cases-per-year" min="0"></td>
                                    <td><input type="number" class="form-control product-bottles-per-case" min="1"></td>
                                    <td><input type="number" class="form-control product-bulk-quantity" min="0"></td>
                                    <td>
                                        <button class="btn btn-sm btn-danger remove-product">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-success" id="addProductRow">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                        <button class="btn btn-secondary" id="clearProducts">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="text-center mt-4 mb-4">
                <button class="btn btn-primary btn-lg" id="calculateBtn">Calculate</button>
                <button class="btn btn-success btn-lg" id="generateReportBtn" disabled>Generate Report</button>
            </div>

            <!-- Results Section (initially hidden) -->
            <div id="resultsSection" style="display:none;">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h4 class="mb-0">Summary Results</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tbody>
                                        <tr>
                                            <th>Peak Additional Investment</th>
                                            <td id="peakInvestment"></td>
                                        </tr>
                                        <tr>
                                            <th>Average Investment</th>
                                            <td id="averageInvestment"></td>
                                        </tr>
                                        <tr>
                                            <th>Total Savings</th>
                                            <td id="totalSavings"></td>
                                        </tr>
                                        <tr>
                                            <th>ROI</th>
                                            <td id="roi"></td>
                                        </tr>
                                        <tr>
                                            <th>Annualized ROI</th>
                                            <td id="annualizedRoi"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <canvas id="summaryChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h4 class="mb-0">Product Details</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="resultsTable">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Product</th>
                                        <th>Smaller Deal Qty</th>
                                        <th>Larger Deal Qty</th>
                                        <th>Savings Per Bottle</th>
                                        <th>Total Savings</th>
                                        <th>Additional Investment</th>
                                        <th>ROI</th>
                                        <th>Annualized ROI</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <!-- Results will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h4 class="mb-0">Visualization</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-center">ROI by Product</h5>
                                <canvas id="roiChart" width="400" height="300"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-center">Investment vs. Savings</h5>
                                <canvas id="investmentChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Calculator Script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let products = [];
        let calculationResults = null;
        let charts = {};

        // Add first product row by default
        addProductRow();

        // Event Listeners
        document.getElementById('addProductRow').addEventListener('click', addProductRow);
        document.getElementById('clearProducts').addEventListener('click', clearProducts);
        document.getElementById('calculateBtn').addEventListener('click', calculateResults);
        document.getElementById('generateReportBtn').addEventListener('click', generateReport);
        document.getElementById('saveScenario').addEventListener('click', saveScenario);
        document.getElementById('loadScenario').addEventListener('click', loadSelectedScenario);

        // Load scenarios on page load
        loadScenarioList();

        // Functions
        function addProductRow() {
            const template = document.getElementById('productRowTemplate');
            const tbody = document.getElementById('productsTableBody');

            const newRow = template.cloneNode(true);
            newRow.style.display = '';
            newRow.id = 'product-' + Date.now();

            // Add event listener to remove button
            newRow.querySelector('.remove-product').addEventListener('click', function() {
                tbody.removeChild(newRow);
            });

            tbody.appendChild(newRow);
        }

        function clearProducts() {
            if (confirm('Are you sure you want to clear all products?')) {
                const tbody = document.getElementById('productsTableBody');
                // Remove all rows except template
                Array.from(tbody.children).forEach(row => {
                    if (row.id !== 'productRowTemplate') {
                        tbody.removeChild(row);
                    }
                });

                // Add one empty row
                addProductRow();
            }
        }

        function collectProductData() {
            products = [];
            const rows = document.querySelectorAll('#productsTableBody tr:not(#productRowTemplate)');

            rows.forEach(row => {
                const productName = row.querySelector('.product-name').value.trim();
                if (!productName) return; // Skip empty rows

                const product = {
                    product_name: productName,
                    current_price: parseFloat(row.querySelector('.product-current-price').value) || 0,
                    bulk_price: parseFloat(row.querySelector('.product-bulk-price').value) || 0,
                    cases_on_hand: parseInt(row.querySelector('.product-cases-on-hand').value) || 0,
                    cases_per_year: parseInt(row.querySelector('.product-cases-per-year').value) || 0,
                    bottles_per_case: parseInt(row.querySelector('.product-bottles-per-case').value) || 0,
                    bulk_quantity: parseInt(row.querySelector('.product-bulk-quantity').value) || 0
                };

                products.push(product);
            });

            return products;
        }

        function calculateResults() {
            const products = collectProductData();
            if (products.length === 0) {
                alert('Please add at least one product with data.');
                return;
            }

            // Get parameters
            const params = {
                small_deal_minimum: parseInt(document.getElementById('smallDealMinimum').value) || 30,
                bulk_deal_minimum: parseInt(document.getElementById('bulkDealMinimum').value) || 60,
                payment_terms: parseInt(document.getElementById('paymentTerms').value) || 30
            };

            // Send data to server for calculation
            fetch('/api/calculate-multi-product-deal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    parameters: params,
                    products: products
                })
            })
            .then(response => response.json())
            .then(data => {
                calculationResults = data;
                displayResults(data);
                document.getElementById('generateReportBtn').disabled = false;
                document.getElementById('resultsSection').style.display = 'block';
            })
            .catch(error => {
                console.error('Error calculating results:', error);
                alert('Error calculating results. Please check the console for details.');
            });
        }

        function displayResults(data) {
            // Display summary results
            document.getElementById('peakInvestment').textContent = formatCurrency(data.summary.peak_additional_investment);
            document.getElementById('averageInvestment').textContent = formatCurrency(data.summary.average_additional_investment);
            document.getElementById('totalSavings').textContent = formatCurrency(data.summary.total_savings);
            document.getElementById('roi').textContent = formatPercent(data.summary.roi);
            document.getElementById('annualizedRoi').textContent = formatPercent(data.summary.annualized_roi);

            // Display product results
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            data.products.forEach(product => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${product.product_name}</td>
                    <td>${formatNumber(product.smaller_deal_quantity)}</td>
                    <td>${formatNumber(product.larger_deal_quantity)}</td>
                    <td>${formatCurrency(product.savings_per_bottle)}</td>
                    <td>${formatCurrency(product.total_savings)}</td>
                    <td>${formatCurrency(product.peak_additional_investment)}</td>
                    <td>${formatPercent(product.roi)}</td>
                    <td>${formatPercent(product.annualized_roi)}</td>
                `;

                tbody.appendChild(row);
            });

            // Create charts
            createCharts(data);
        }

        function createCharts(data) {
            // Destroy existing charts to prevent duplicates
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Prepare data for charts
            const productNames = data.products.map(p => p.product_name);
            const roiValues = data.products.map(p => p.roi);
            const annRoiValues = data.products.map(p => p.annualized_roi);
            const investmentValues = data.products.map(p => p.peak_additional_investment);
            const savingsValues = data.products.map(p => p.total_savings);

            // ROI chart
            const roiCtx = document.getElementById('roiChart').getContext('2d');
            charts.roi = new Chart(roiCtx, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [
                        {
                            label: 'ROI',
                            data: roiValues,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 1
                        },
                        {
                            label: 'Annualized ROI',
                            data: annRoiValues,
                            backgroundColor: 'rgba(255, 159, 64, 0.5)',
                            borderColor: 'rgb(255, 159, 64)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + (context.raw * 100).toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Investment vs Savings chart
            const invCtx = document.getElementById('investmentChart').getContext('2d');
            charts.investment = new Chart(invCtx, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [
                        {
                            label: 'Additional Investment',
                            data: investmentValues,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 1
                        },
                        {
                            label: 'Total Savings',
                            data: savingsValues,
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.raw.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            // Summary chart (Investment vs Savings)
            const summaryCtx = document.getElementById('summaryChart').getContext('2d');
            charts.summary = new Chart(summaryCtx, {
                type: 'pie',
                data: {
                    labels: ['Peak Investment', 'Total Savings'],
                    datasets: [{
                        data: [
                            data.summary.peak_additional_investment,
                            data.summary.total_savings
                        ],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(75, 192, 192, 0.5)'
                        ],
                        borderColor: [
                            'rgb(255, 99, 132)',
                            'rgb(75, 192, 192)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.raw.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateReport() {
            if (!calculationResults) {
                alert('Please calculate results first.');
                return;
            }

            // Get parameters
            const params = {
                small_deal_minimum: parseInt(document.getElementById('smallDealMinimum').value) || 30,
                bulk_deal_minimum: parseInt(document.getElementById('bulkDealMinimum').value) || 60,
                payment_terms: parseInt(document.getElementById('paymentTerms').value) || 30
            };

            // Send data to server for report generation
            fetch('/api/generate-multi-product-deal-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    parameters: params,
                    results: calculationResults
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.filename) {
                    window.location.href = '/download/' + data.filename;
                } else {
                    alert('Error generating report: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error generating report:', error);
                alert('Error generating report. Please check the console for details.');
            });
        }

        function saveScenario() {
            const scenarioName = document.getElementById('scenarioName').value.trim();
            if (!scenarioName) {
                alert('Please enter a scenario name.');
                return;
            }

            const products = collectProductData();
            if (products.length === 0) {
                alert('Please add at least one product with data.');
                return;
            }

            // Get parameters
            const params = {
                small_deal_minimum: parseInt(document.getElementById('smallDealMinimum').value) || 30,
                bulk_deal_minimum: parseInt(document.getElementById('bulkDealMinimum').value) || 60,
                payment_terms: parseInt(document.getElementById('paymentTerms').value) || 30
            };

            // Send data to server for saving
            fetch('/api/save-multi-product-scenario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: scenarioName,
                    parameters: params,
                    products: products
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Scenario saved successfully.');
                    loadScenarioList();
                } else {
                    alert('Error saving scenario: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving scenario:', error);
                alert('Error saving scenario. Please check the console for details.');
            });
        }

        function loadScenarioList() {
            fetch('/api/list-multi-product-scenarios')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('scenarioSelect');

                    // Clear existing options except first
                    while (select.options.length > 1) {
                        select.remove(1);
                    }

                    // Add new options
                    data.scenarios.forEach(scenario => {
                        const option = document.createElement('option');
                        option.value = scenario;
                        option.textContent = scenario;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading scenarios:', error);
                });
        }

        function loadSelectedScenario() {
            const scenarioName = document.getElementById('scenarioSelect').value;
            if (!scenarioName) {
                alert('Please select a scenario to load.');
                return;
            }

            fetch('/api/get-multi-product-scenario/' + encodeURIComponent(scenarioName))
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error loading scenario: ' + data.error);
                        return;
                    }

                    // Set parameters
                    document.getElementById('smallDealMinimum').value = data.parameters.small_deal_minimum;
                    document.getElementById('bulkDealMinimum').value = data.parameters.bulk_deal_minimum;
                    document.getElementById('paymentTerms').value = data.parameters.payment_terms;

                    // Clear existing products and set scenario name
                    document.getElementById('scenarioName').value = scenarioName;
                    clearProducts();

                    // Add products
                    const tbody = document.getElementById('productsTableBody');
                    tbody.innerHTML = ''; // Clear all rows including template
                    tbody.appendChild(document.getElementById('productRowTemplate')); // Re-add template

                    data.products.forEach(product => {
                        const template = document.getElementById('productRowTemplate');
                        const newRow = template.cloneNode(true);
                        newRow.style.display = '';
                        newRow.id = 'product-' + Date.now() + Math.random();

                        newRow.querySelector('.product-name').value = product.product_name;
                        newRow.querySelector('.product-current-price').value = product.current_price;
                        newRow.querySelector('.product-bulk-price').value = product.bulk_price;
                        newRow.querySelector('.product-cases-on-hand').value = product.cases_on_hand;
                        newRow.querySelector('.product-cases-per-year').value = product.cases_per_year;
                        newRow.querySelector('.product-bottles-per-case').value = product.bottles_per_case;
                        newRow.querySelector('.product-bulk-quantity').value = product.bulk_quantity;

                        // Add event listener to remove button
                        newRow.querySelector('.remove-product').addEventListener('click', function() {
                            tbody.removeChild(newRow);
                        });

                        tbody.appendChild(newRow);
                    });

                    alert('Scenario loaded successfully.');
                })
                .catch(error => {
                    console.error('Error loading scenario:', error);
                    alert('Error loading scenario. Please check the console for details.');
                });
        }

        // Utility functions
        function formatCurrency(value) {
            return '$' + parseFloat(value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function formatPercent(value) {
            return (parseFloat(value) * 100).toFixed(2) + '%';
        }

        function formatNumber(value) {
            return parseFloat(value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
    });
</script>
{% endblock %}
