{% extends "base.html" %}

{% block title %}Multi-Product Buying Calculator{% endblock %}

{% block additional_style %}
<style>
    /* Make container wider */
    .container-fluid.mt-4 {
        max-width: 98%;
    }

    /* Better table layout - wider pricing columns */
    #productsTable {
        table-layout: fixed;
        width: 100%;
        min-width: 1400px;
    }

    /* Fixed width for product name column */
    #productsTable th:nth-child(1),
    #productsTable td:nth-child(1) {
        width: 160px;
        max-width: 160px;
        min-width: 160px;
    }

    /* WIDER Pricing columns - make them clearly visible */
    #productsTable th:nth-child(2), #productsTable td:nth-child(2) {
        width: 80px;
        max-width: 80px;
        background-color: #f8f9fa;
        font-weight: 600;
    }

    #productsTable th:nth-child(3), #productsTable td:nth-child(3) {
        width: 80px;
        max-width: 80px;
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        font-weight: 700;
    }

    /* Cases columns */
    #productsTable th:nth-child(4), #productsTable td:nth-child(4),
    #productsTable th:nth-child(5), #productsTable td:nth-child(5),
    #productsTable th:nth-child(6), #productsTable td:nth-child(6) {
        width: 70px;
        max-width: 80px;
    }

    /* Small Deal, Bulk Cases, Cases After Purchase */
    #productsTable th:nth-child(7), #productsTable td:nth-child(7),
    #productsTable th:nth-child(8), #productsTable td:nth-child(8),
    #productsTable th:nth-child(9), #productsTable td:nth-child(9) {
        width: 90px;
        max-width: 90px;
    }

    /* ROI columns */
    #productsTable th:nth-child(10), #productsTable td:nth-child(10),
    #productsTable th:nth-child(11), #productsTable td:nth-child(11),
    #productsTable th:nth-child(12), #productsTable td:nth-child(12) {
        width: 100px;
        max-width: 100px;
    }

    /* Action column */
    #productsTable th:nth-child(13), #productsTable td:nth-child(13) {
        width: 70px;
        max-width: 70px;
    }

    /* Make bulk price column stand out more */
    .product-bulk-price {
        background-color: #fff3cd !important;
        border: 2px solid #ffc107 !important;
        font-weight: 700 !important;
        font-size: 0.95rem !important;
    }

    /* Make small price column more visible */
    .product-small-price {
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6 !important;
        font-weight: 600 !important;
        font-size: 0.95rem !important;
    }

    #productsTable .product-name {
        white-space: normal;
        word-wrap: break-word;
    }

    /* Auto-fit other columns */
    #productsTable th:not(:first-child),
    #productsTable td:not(:first-child) {
        text-align: center;
    }

    /* Improve header legibility */
    .card-header.bg-light {
        background-color: #f2f2f2 !important;
        border-bottom: 1px solid #dee2e6;
    }

    .card-header.bg-light h4 {
        color: #212529;
        font-weight: 600;
    }

    /* Make table headers more readable */
    .thead-light th {
        background-color: #f2f2f2 !important;
        color: #212529;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
        font-size: 0.85rem;
        vertical-align: middle;
        padding: 0.4rem 0.3rem;
    }

    /* Special styling for Pricing header row */
    .thead-light th[colspan="2"] {
        background-color: #e9ecef !important;
        font-weight: 700;
        border: 2px solid #6c757d;
        font-size: 0.9rem;
    }

    /* Improve form label contrast */
    label {
        color: #212529;
        font-weight: 500;
    }

    /* Table cells alignment */
    .table td.numeric {
        text-align: right;
    }

    /* Highlight positive ROI values */
    .positive-roi {
        color: #28a745;
        font-weight: 600;
    }

    /* Highlight negative ROI values */
    .negative-roi {
        color: #dc3545;
        font-weight: 600;
    }

    /* Input validation */
    input:invalid {
        border-color: #dc3545;
    }

    /* Show validation tooltip */
    .invalid-feedback {
        display: none;
    }

    input:invalid + .invalid-feedback {
        display: block;
    }

    /* Tooltip styling */
    .tooltip-icon {
        margin-left: 5px;
        color: #6c757d;
        cursor: help;
    }

    .tooltip-icon:hover {
        color: #007bff;
    }

    /* Enable tooltips */
    [data-toggle="tooltip"] {
        cursor: help;
    }

    /* Scenario management styling */
    .scenario-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .nav-link {
        cursor: pointer;
    }

    /* Total row styling */
    .total-row {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    /* Better input field sizing */
    .form-control {
        padding: 0.3rem 0.5rem;
        font-size: 0.9rem;
    }

    /* Input fields for pricing - make them more prominent */
    #productsTable .product-small-price,
    #productsTable .product-bulk-price {
        font-size: 0.95rem !important;
        padding: 0.4rem 0.6rem !important;
        text-align: center !important;
        font-weight: 600 !important;
    }

    /* Compact view toggle functionality */
    .detail-column {
        display: table-cell;
    }

    .table.compact .detail-column {
        display: none;
    }

    /* Ensure proper table layout in compact mode */
    .table.compact {
        table-layout: auto;
        min-width: 900px;
    }

    .table.compact th,
    .table.compact td {
        text-align: center;
        vertical-align: middle;
        padding: 0.3rem 0.2rem;
        font-size: 0.85rem;
    }

    /* Adjust product name column in compact mode */
    .table.compact th:first-child,
    .table.compact td:first-child {
        text-align: left;
        width: 200px;
        max-width: 200px;
    }

    /* Pricing columns in compact mode - still need to be visible */
    .table.compact th:nth-child(2), .table.compact td:nth-child(2) {
        width: 110px;
        max-width: 110px;
    }

    /* Grouped header styling */
    .thead-light th[colspan] {
        text-align: center;
        font-weight: 700;
        background-color: #e9ecef !important;
    }

    /* Toggle switch styling */
    .compact-toggle {
        margin-bottom: 1rem;
    }

    /* Portfolio summary row styling */
    #totalRow {
        background-color: #e9ecef !important;
        border-top: 2px solid #007bff !important;
    }

    #totalRow td {
        font-weight: 700 !important;
        font-size: 0.95rem;
    }

    /* Validation styling */
    .validation-error {
        border-color: #dc3545 !important;
        background-color: #f8d7da !important;
    }

    .validation-warning {
        border-color: #ffc107 !important;
        background-color: #fff3cd !important;
    }

    .validation-success {
        border-color: #28a745 !important;
        background-color: #d4edda !important;
    }

    .validation-message {
        display: none;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .validation-message.error {
        color: #dc3545;
        display: block;
    }

    .validation-message.warning {
        color: #856404;
        display: block;
    }

    .validation-message.success {
        color: #155724;
        display: block;
    }

    /* Bulk cases total indicator */
    .bulk-cases-total {
        font-weight: bold;
        padding: 0.5rem;
        border-radius: 0.25rem;
        margin-bottom: 1rem;
        text-align: center;
    }

    .bulk-cases-total.valid {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .bulk-cases-total.invalid {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .bulk-cases-total.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    /* Bulk cases header indicator */
    .bulk-cases-header-indicator {
        margin-top: 0.25rem;
        font-size: 0.75rem;
    }

    .bulk-cases-header-indicator.valid {
        color: #155724;
    }

    .bulk-cases-header-indicator.invalid {
        color: #721c24;
        font-weight: bold;
    }

    .bulk-cases-header-indicator.warning {
        color: #856404;
        font-weight: bold;
    }

    #productsInputTable {
        table-layout: fixed;
        width: 100%;
    }
    #productsInputTable th, #productsInputTable td {
        font-size: 0.92rem;
        padding: 0.5rem 0.7rem;
        text-align: center;
        vertical-align: middle;
    }
    #productsInputTable th.product-name, #productsInputTable td.product-name {
        width: 55%;
        text-align: left;
        white-space: normal;
        word-break: break-word;
    }
    #productsInputTable th.price, #productsInputTable td.price,
    #productsInputTable th.cases, #productsInputTable td.cases,
    #productsInputTable th.bulk-cases, #productsInputTable td.bulk-cases {
        width: 75px;
        min-width: 75px;
        max-width: 75px;
        text-align: right;
        font-size: 0.92rem;
        vertical-align: middle;
    }
    #productsInputTable th.action, #productsInputTable td.action {
        width: 36px;
        min-width: 36px;
        max-width: 36px;
        text-align: center;
        vertical-align: middle;
    }
    #productsInputTable .product-name input {
        width: 100%;
        text-align: left;
        white-space: normal;
        overflow-wrap: break-word;
        font-size: 0.92rem;
        min-width: 0;
        max-width: none;
        vertical-align: middle;
    }
    #productsInputTable .action button {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        background: #dc3545;
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 4px 10px;
        font-size: 1.1em;
        cursor: pointer;
        transition: background 0.2s;
        height: 28px;
        width: 28px;
    }
    #productsInputTable .action button:hover {
        background: #b52a37;
    }

    /* --- BEGIN: Improved Product Table CSS (User Provided) --- */

    /* 1. WIDER PRODUCT NAME COLUMN - This is the key fix */
    #productsInputTable th.product-name,
    #productsInputTable td.product-name {
        width: 240px !important; /* Increased from 55% */
        min-width: 240px !important;
        max-width: 240px !important;
    }

    #productsInputTable .product-name input {
        width: 100%;
        text-align: left;
        font-size: 0.9rem;
        padding: 0.5rem;
        /* Allow text wrapping in product name inputs */
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        min-height: 38px;
    }

    /* 2. BETTER COLUMN WIDTHS - Prevent header text wrapping */
    #productsInputTable th, #productsInputTable td {
        font-size: 0.9rem;
        padding: 0.5rem 0.4rem;
        vertical-align: middle;
        white-space: nowrap; /* Prevent header text wrapping */
    }

    /* 3. IMPROVED PRICING COLUMNS */
    #productsInputTable th.price, #productsInputTable td.price {
        width: 80px !important;
        max-width: 80px !important;
        min-width: 80px !important;
        text-align: right;
    }

    /* 4. BETTER INVENTORY COLUMNS */
    #productsInputTable th.cases, #productsInputTable td.cases,
    #productsInputTable th.bulk-cases, #productsInputTable td.bulk-cases {
        width: 60px !important;
        min-width: 60px !important;
        max-width: 60px !important;
        text-align: right;
    }

    /* 5. IMPROVED VISUAL HIERARCHY FOR PRICING */
    #productsInputTable .product-small-price {
        background-color: inherit !important;
        border: 1px solid #dee2e6 !important;
        font-weight: 500 !important;
        box-shadow: none;
    }

    #productsInputTable .product-bulk-price {
        background-color: inherit !important;
        border: 1px solid #dee2e6 !important;
        font-weight: 600 !important;
        box-shadow: none;
    }

    #productsInputTable .product-bulk-cases {
        background-color: inherit !important;
        border: 1px solid #dee2e6 !important;
        font-weight: 600 !important;
    }

    /* 6. RIGHT-ALIGN ALL NUMERIC INPUTS */
    #productsInputTable .price input,
    #productsInputTable .cases input,
    #productsInputTable .bulk-cases input {
        text-align: right !important;
        font-weight: 500;
        padding: 0.4rem 0.6rem;
    }

    /* 7. BETTER TABLE CONTAINER */
    .table-responsive {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #dee2e6;
    }

    #productsInputTable {
        margin-bottom: 0;
        min-width: 1000px; /* Ensure readable minimum width */
    }

    /* 8. IMPROVED HEADERS */
    #productsInputTable thead th {
        background-color: #f1f3f4 !important;
        color: #212529;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
        text-align: center;
        font-size: 0.85rem;
        padding: 0.6rem 0.4rem;
    }

    /* Product name header stays left-aligned */
    #productsInputTable thead th.product-name {
        text-align: left !important;
    }

    /* 9. BETTER ACTION BUTTONS */
    #productsInputTable .action {
        width: 50px;
        min-width: 50px;
        max-width: 50px;
        text-align: center;
    }

    #productsInputTable .action button {
        background: linear-gradient(135deg, #dc3545, #c82333);
        border: none;
        border-radius: 6px;
        color: white;
        padding: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(220,53,69,0.25);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #productsInputTable .action button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220,53,69,0.35);
        background: linear-gradient(135deg, #c82333, #a71e2a);
    }

    /* 10. COMPACT VIEW IMPROVEMENTS */
    .table.compact .detail-column {
        display: none;
    }

    .table.compact #productsInputTable {
        min-width: 650px; /* Smaller when compact */
    }

    .table.compact #productsInputTable th.product-name,
    .table.compact #productsInputTable td.product-name {
        width: 280px !important; /* Even more room in compact mode */
        min-width: 280px !important;
    }

    /* 11. BULK CASES VALIDATION INDICATOR */
    .bulk-cases-total {
        padding: 0.75rem;
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
        margin-bottom: 1rem;
        border: 2px solid;
    }

    .bulk-cases-total.valid {
        background-color: #d4edda;
        color: #155724;
        border-color: #28a745;
    }

    .bulk-cases-total.invalid {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #dc3545;
    }

    .bulk-cases-total.warning {
        background-color: #fff3cd;
        color: #856404;
        border-color: #ffc107;
    }

    /* 12. FORM VALIDATION STYLING */
    .form-control.is-invalid {
        border-color: #dc3545 !important;
        background-color: #fef5f5 !important;
    }

    .form-control.is-valid {
        border-color: #28a745 !important;
        background-color: #f5fef5 !important;
    }

    /* 13. RESPONSIVE IMPROVEMENTS */
    @media (max-width: 1200px) {
        #productsInputTable th.product-name,
        #productsInputTable td.product-name {
            width: 200px !important;
            min-width: 200px !important;
        }

        #productsInputTable th.price, #productsInputTable td.price,
        #productsInputTable th.cases, #productsInputTable td.cases {
            width: 75px;
            min-width: 75px;
        }
    }

    /* 14. IMPROVE OVERALL TABLE SPACING */
    #productsInputTable tbody tr:hover {
        background-color: #f8f9fa;
    }

    #productsInputTable tbody tr {
        transition: background-color 0.2s ease;
    }

    /* 15. BETTER FOCUS STATES */
    #productsInputTable input:focus {
        border-color: #007bff !important;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25) !important;
        background-color: #fff !important;
    }

    /* --- END: Improved Product Table CSS (User Provided) --- */

    /* --- BEGIN: ADDITIONAL REFINEMENTS (May 2024) --- */

    /* 1. BETTER HEADER GROUPING with spanning headers */
    .table-header-group {
        background-color: #e9ecef !important;
        border: 2px solid #6c757d !important;
        font-weight: 700 !important;
        text-align: center !important;
        color: #495057 !important;
        font-size: 0.9rem !important;
    }

    /* 2. REMOVE DROPDOWN VISUAL CLUTTER - Hide dropdown arrows where not needed */
    #productsInputTable input[type="number"] {
        -webkit-appearance: none;
        -moz-appearance: textfield;
    }

    #productsInputTable input[type="number"]::-webkit-outer-spin-button,
    #productsInputTable input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* 3. IMPROVE ROW SEPARATION */
    #productsInputTable tbody tr {
        border-bottom: 1px solid #e3e6ea;
    }

    #productsInputTable tbody tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    #productsInputTable tbody tr:hover {
        background-color: #e8f4f8 !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }

    /* 4. BETTER COLUMN VISUAL SEPARATION */
    #productsInputTable th:nth-child(2), /* Small Price */
    #productsInputTable td:nth-child(2) {
        border-left: 2px solid #dee2e6;
    }

    #productsInputTable th:nth-child(4), /* On Hand */
    #productsInputTable td:nth-child(4) {
        border-left: 2px solid #dee2e6;
    }

    #productsInputTable th:nth-child(7), /* Bulk Quantity */
    #productsInputTable td:nth-child(7) {
        border-left: 2px solid #dee2e6;
    }

    #productsInputTable th:nth-child(8), /* Action */
    #productsInputTable td:nth-child(8) {
        border-left: 2px solid #dee2e6;
    }

    /* 5. ENHANCED ACTION BUTTONS */
    #productsInputTable .action button {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border: none;
        border-radius: 8px;
        color: white;
        padding: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(220,53,69,0.3);
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    #productsInputTable .action button:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(220,53,69,0.4);
        background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
    }

    #productsInputTable .action button:active {
        transform: translateY(0) scale(0.95);
        box-shadow: 0 2px 4px rgba(220,53,69,0.3);
    }

    /* 6. IMPROVE HEADER STYLING */
    #productsInputTable thead th {
        background: linear-gradient(180deg, #f8f9fa 0%, #f1f3f4 100%);
        color: #495057;
        font-weight: 600;
        border-bottom: 3px solid #dee2e6;
        text-align: center;
        font-size: 0.85rem;
        padding: 0.8rem 0.5rem;
        position: relative;
    }

    #productsInputTable thead th.product-name {
        text-align: left !important;
        font-weight: 700;
    }

    /* 7. ADD SUBTLE SHADOWS TO PRICING COLUMNS */
    #productsInputTable .product-small-price {
        background-color: inherit !important;
        border: 1px solid #dee2e6 !important;
        font-weight: 500 !important;
        box-shadow: none;
    }

    #productsInputTable .product-bulk-price {
        background-color: inherit !important;
        border: 1px solid #dee2e6 !important;
        font-weight: 600 !important;
        box-shadow: none;
    }

    /* 8. IMPROVE FOCUS STATES */
    #productsInputTable input:focus {
        border-color: #007bff !important;
        box-shadow: 0 0 0 0.25rem rgba(0,123,255,0.15) !important;
        background-color: #fff !important;
        transform: scale(1.02);
        z-index: 10;
        position: relative;
    }

    /* 9. BETTER COMPACT VIEW */
    .table.compact #productsInputTable thead th:not(.product-name):not(.price):not(.bulk-cases):not(.action) {
        font-size: 0;
        padding: 0.4rem 0.2rem;
    }

    .table.compact #productsInputTable thead th:not(.product-name):not(.price):not(.bulk-cases):not(.action):after {
        content: "Hidden";
        font-size: 0.7rem;
        color: #6c757d;
        font-style: italic;
    }

    /* 10. RESPONSIVE HEADER IMPROVEMENTS */
    @media (max-width: 1200px) {
        #productsInputTable thead th {
            font-size: 0.75rem;
            padding: 0.6rem 0.3rem;
        }

        #productsInputTable th, #productsInputTable td {
            font-size: 0.85rem;
            padding: 0.4rem 0.3rem;
        }
    }

    /* 11. IMPROVE TABLE CONTAINER */
    .table-responsive {
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        border: 1px solid #e3e6ea;
        overflow: hidden;
    }

    #productsInputTable {
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
    }

    /* 12. ADD LOADING STATE STYLING (for when data is being loaded) */
    .table-loading {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
    }

    .table-loading::after {
        content: "Loading...";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.9);
        padding: 1rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        z-index: 1000;
    }

    /* 13. IMPROVE BULK QUANTITY COLUMN HIGHLIGHTING */
    #productsInputTable th:nth-child(7), /* Bulk Quantity header */
    #productsInputTable td:nth-child(7) { /* Bulk Quantity cells */
        background-color: inherit !important;
        border-left: 2px solid #dee2e6 !important;
    }

    #productsInputTable .product-bulk-cases {
        background-color: inherit !important;
        border: 1px solid #dee2e6 !important;
        font-weight: 600 !important;
    }

    /* 14. ADD SUBTLE ANIMATIONS */
    #productsInputTable tbody tr {
        transition: all 0.2s ease;
    }

    #productsInputTable input {
        transition: all 0.2s ease;
    }

    /* 15. IMPROVE TOOLTIP POSITIONING (if you add tooltips later) */
    .table-tooltip {
        position: relative;
    }

    .table-tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        white-space: nowrap;
        z-index: 1000;
    }

    /* --- END: ADDITIONAL REFINEMENTS (May 2024) --- */

    /* Header alignment: all center except Product Name */
    #productsInputTable thead th {
        text-align: center !important;
    }
    #productsInputTable thead th.product-name {
        text-align: left !important;
    }

    #productsInputTable td.price {
        text-align: right !important;
    }
    #productsInputTable .price input,
    #productsInputTable .product-small-price input,
    #productsInputTable .product-bulk-price input {
        text-align: right !important;
    }

    #productsInputTable td.price,
    #productsInputTable td.price input,
    #productsInputTable .product-small-price,
    #productsInputTable .product-small-price input,
    #productsInputTable .product-bulk-price,
    #productsInputTable .product-bulk-price input {
        text-align: right !important;
    }

    #productsInputTable td.cases,
    #productsInputTable td.cases input,
    #productsInputTable .product-cases-on-hand,
    #productsInputTable .product-cases-on-hand input,
    #productsInputTable .product-annual-cases,
    #productsInputTable .product-annual-cases input,
    #productsInputTable .product-bottles-per-case,
    #productsInputTable .product-bottles-per-case input,
    #productsInputTable td.bulk-cases,
    #productsInputTable td.bulk-cases input,
    #productsInputTable .product-bulk-cases,
    #productsInputTable .product-bulk-cases input {
        text-align: right !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="text-center mb-0">Multi-Product Buying Calculator</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <p class="lead text-center">
                                Analyze the ROI of purchasing multiple related products at bulk discount pricing
                            </p>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs mb-4" id="calculatorTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="calculator-tab" data-bs-toggle="tab" data-bs-target="#calculator" type="button" role="tab" aria-controls="calculator" aria-selected="true">Calculator</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="scenarios-tab" data-bs-toggle="tab" data-bs-target="#scenarios" type="button" role="tab" aria-controls="scenarios" aria-selected="false">Saved Scenarios</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button" role="tab" aria-controls="help" aria-selected="false">Help</a>
                        </li>
                    </ul>

                    <div class="tab-content" id="calculatorTabContent">
                        <!-- Calculator Tab -->
                        <div class="tab-pane fade show active" id="calculator" role="tabpanel" aria-labelledby="calculator-tab">
                            <!-- Parameters Panel -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h4 class="mb-0">Parameters</h4>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="smallDealCases">Small Deal Quantity
                                                    <i class="fas fa-info-circle tooltip-icon" data-toggle="tooltip"
                                                       title="Number of cases in the small deal for ROI comparison"></i>
                                                </label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="smallDealCases" min="1" value="15" required>
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">cases</span>
                                                    </div>
                                                    <div class="invalid-feedback">
                                                        Small deal quantity must be at least 1 case
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="dealSizeCases">Deal Size (Bulk)
                                                    <i class="fas fa-info-circle tooltip-icon" data-toggle="tooltip"
                                                       title="Total number of cases in the bulk deal"></i>
                                                </label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="dealSizeCases" min="1" value="60" required>
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">cases</span>
                                                    </div>
                                                    <div class="invalid-feedback">
                                                        Deal size must be at least 1 case
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="minDaysStock">Minimum Days Stock
                                                    <i class="fas fa-info-circle tooltip-icon" data-toggle="tooltip"
                                                       title="Minimum number of days of stock required after allocation"></i>
                                                </label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="minDaysStock" min="0" value="30" required>
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">days</span>
                                                    </div>
                                                    <div class="invalid-feedback">
                                                        Minimum days stock cannot be negative
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="paymentTermsDays">Payment Terms
                                                    <i class="fas fa-info-circle tooltip-icon" data-toggle="tooltip"
                                                       title="Number of days until payment is due"></i>
                                                </label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="paymentTermsDays" min="0" value="30" required>
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">days</span>
                                                    </div>
                                                    <div class="invalid-feedback">
                                                        Payment terms cannot be negative
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="iterations">Optimization Iterations
                                                    <i class="fas fa-info-circle tooltip-icon" data-toggle="tooltip"
                                                       title="Number of optimization iterations to run"></i>
                                                </label>
                                                <select class="form-control" id="iterations">
                                                    <option value="0">None (Proportional Only)</option>
                                                    <option value="1">1 Iteration</option>
                                                    <option value="5">5 Iterations</option>
                                                    <option value="10">10 Iterations</option>
                                                    <option value="auto" selected>Auto (Until Converged)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Scenario Name (moved from separate panel to the products panel) -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="scenarioName">Scenario Name (for saving)</label>
                                        <input type="text" class="form-control" id="scenarioName" placeholder="e.g., Premium Spirits Portfolio">
                                    </div>
                                </div>
                            </div>

                            <!-- Products Section -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h4 class="mb-0">Product Input</h4>
                                </div>
                                <div class="card-body">
                                    <!-- Compact View Toggle -->
                                    <div class="compact-toggle">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="compactViewToggle">
                                            <label class="form-check-label" for="compactViewToggle">
                                                Compact View (hides Cases On Hand, Annual Cases, Bottles/Case)
                                            </label>
                                        </div>
                                    </div>

                                    <!-- INPUT TABLE -->
                                    <div class="table-responsive mb-4">
                                        <table class="table table-bordered table-hover" id="productsInputTable">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th class="product-name">Product Name</th>
                                                    <th class="price">Small<br>Price</th>
                                                    <th class="price">Bulk<br>Price</th>
                                                    <th class="cases detail-column">On<br>Hand</th>
                                                    <th class="cases detail-column">Annual<br>Cases</th>
                                                    <th class="cases detail-column">Bottles<br>per Case</th>
                                                    <th class="bulk-cases">Bulk<br>Quantity</th>
                                                    <th class="action">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productsTableBody">
                                                <tr id="productRowTemplate" style="display: none;">
                                                    <td class="product-name"><input type="text" class="form-control product-name" placeholder="Product Name" required></td>
                                                    <td class="price"><input type="number" class="form-control product-small-price numeric-input" min="0.01" step="0.01" placeholder="$" required></td>
                                                    <td class="price"><input type="number" class="form-control product-bulk-price numeric-input" min="0.01" step="0.01" placeholder="$" required></td>
                                                    <td class="cases detail-column"><input type="number" class="form-control product-cases-on-hand numeric-input" min="0" placeholder="Cases" required></td>
                                                    <td class="cases detail-column"><input type="number" class="form-control product-annual-cases numeric-input" min="1" placeholder="Cases/Year" required></td>
                                                    <td class="cases detail-column"><input type="number" class="form-control product-bottles-per-case numeric-input" min="1" placeholder="Bottles" required></td>
                                                    <td class="bulk-cases"><input type="number" class="form-control product-bulk-cases numeric-input" min="0" placeholder="auto"></td>
                                                    <td class="action"><button class="btn btn-sm btn-danger remove-product"><i class="fas fa-trash"></i></button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <div class="mt-3">
                                        <button class="btn btn-success" id="addProductRow">
                                            <i class="fas fa-plus"></i> Add Product
                                        </button>
                                        <button class="btn btn-secondary" id="clearProducts">
                                            <i class="fas fa-trash"></i> Clear All
                                        </button>
                                    </div>

                                    <!-- Bulk Cases Validation Indicator - MOVED HERE for better UX positioning -->
                                    <div id="bulkCasesIndicator" class="bulk-cases-total mt-3 mb-2" style="display: none;">
                                        <span id="bulkCasesIndicatorText">Bulk Cases: 0 / 60 (Available: 60)</span>
                                    </div>
                                </div>
                            </div>

                            <!-- RESULTS TABLE SECTION -->
                            <div class="card mb-4" id="resultsTableSection" style="display: none;">
                                <div class="card-header bg-light">
                                    <h4 class="mb-0">Calculation Results</h4>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-striped" id="productsResultsTable">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th>Product Name</th>
                                                    <th>Small Deal</th>
                                                    <th>Bulk Cases</th>
                                                    <th>Cases After Purchase</th>
                                                    <th>ROI</th>
                                                    <th>After-Terms ROI Multiplier</th>
                                                    <th>Ann. ROI</th>
                                                </tr>
                                            </thead>
                                            <tbody id="resultsTableBody">
                                                <!-- Results populated by JavaScript -->
                                                <tr id="resultsTotalRow" class="table-secondary font-weight-bold">
                                                    <td>TOTALS</td>
                                                    <td id="totalSmallDealCases">0</td>
                                                    <td id="totalBulkCases">0</td>
                                                    <td id="totalCasesAfterPurchase">0</td>
                                                    <td id="portfolioROI">-</td>
                                                    <td id="portfolioTurns">-</td>
                                                    <td id="portfolioAnnROI">-</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions Section -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <button id="calculateBtn" class="btn btn-primary w-100">
                                        <i class="fas fa-calculator"></i> Calculate Results
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <div class="btn-group w-100">
                                        <button id="autoAllocationBtn" class="btn btn-outline-secondary">
                                            <i class="fas fa-magic"></i> Auto Allocation
                                        </button>
                                        <button id="iterateBtn" class="btn btn-info" disabled>
                                            <i class="fas fa-sync-alt"></i> Run Optimization
                                        </button>
                                        <button id="saveScenario" class="btn btn-outline-primary">
                                            <i class="fas fa-save"></i> Save
                                        </button>
                                        <button id="exportBtn" class="btn btn-success" disabled>
                                            <i class="fas fa-file-export"></i> Export Results
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Status Message -->
                            <div id="statusMessage" class="alert" style="display: none;"></div>

                            <!-- Results Section (initially hidden) -->
                            <div id="resultsSection" style="display:none;">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h4 class="mb-0">Summary Results</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <table class="table table-bordered">
                                                    <tbody>
                                                        <tr>
                                                            <th>Peak Additional Investment</th>
                                                            <td id="peakInvestment"></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Average Investment</th>
                                                            <td id="averageInvestment"></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Total Savings</th>
                                                            <td id="totalSavings"></td>
                                                        </tr>
                                                        <tr>
                                                            <th>ROI</th>
                                                            <td id="roi"></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Annualized ROI</th>
                                                            <td id="annualizedRoi"></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Optimization Iterations</th>
                                                            <td id="iterationCount"></td>
                                                        </tr>
                                                        <tr style="display: none;">
                                                            <th>Raw Inventory Turnover (Unadjusted)</th>
                                                            <td id="summaryPortfolioTurns"></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Annual ROI Multiplier (After-Terms)</th>
                                                            <td id="portfolioEffectiveTurns"></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="col-md-6">
                                                <canvas id="roiChart" width="400" height="300"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h4 class="mb-0">Optimization History</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped" id="optimizationHistoryTable">
                                                <thead>
                                                    <tr>
                                                        <th>Iteration</th>
                                                        <th>Action</th>
                                                        <th>Portfolio Annualized ROI</th>
                                                        <th>Change</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="optimizationHistoryBody">
                                                    <!-- History will be populated here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Saved Scenarios Tab -->
                        <div class="tab-pane fade" id="scenarios" role="tabpanel" aria-labelledby="scenarios-tab">
                            <div class="row">
                                <div class="col-md-5">
                                    <h4>Saved Scenarios</h4>
                                    <!-- Status message for Saved Scenarios tab -->
                                    <div id="scenariosStatusMessage" class="alert alert-info" style="display:none;"></div>
                                    <div class="list-group scenario-list" id="scenariosList">
                                        {% if scenarios %}
                                            {% for name in scenarios %}
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <button type="button" class="btn btn-outline-primary scenario-item text-start" onclick="loadScenarioDetails('{{ name }}')" data-name="{{ name }}" style="width:60%;">
                                                        {{ name }}
                                                    </button>
                                                    <div class="btn-group" role="group" style="width:38%;">
                                                        <button type="button" class="btn btn-sm btn-success" onclick="loadScenarioToCalculator('{{ name }}')">
                                                            <i class="fas fa-upload"></i> Load
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-danger" onclick="confirmDeleteScenario('{{ name }}')" data-name="{{ name }}">
                                                            <i class="fas fa-trash"></i> Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="list-group-item text-muted">No saved scenarios</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <div id="scenarioDetails" class="card" style="display: none;">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0" id="scenarioDetailName">Scenario Name</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label>Deal Size:</label>
                                                        <div id="scenarioDetailDealSize" class="form-control-plaintext">60 cases</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label>Min Days Stock:</label>
                                                        <div id="scenarioDetailMinDaysStock" class="form-control-plaintext">30 days</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label>Payment Terms:</label>
                                                        <div id="scenarioDetailPaymentTerms" class="form-control-plaintext">30 days</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered table-striped">
                                                    <thead class="thead-light">
                                                        <tr>
                                                            <th rowspan="2">Product</th>
                                                            <th colspan="2">Pricing</th>
                                                            <th rowspan="2" class="detail-column">On Hand</th>
                                                            <th rowspan="2" class="detail-column">Annual Cases</th>
                                                            <th rowspan="2" class="detail-column">Bottles/Case</th>
                                                            <th rowspan="2">Small Deal</th>
                                                            <th rowspan="2">Bulk Cases</th>
                                                            <th rowspan="2">Total Cases</th>
                                                            <th rowspan="2">ROI</th>
                                                            <th rowspan="2">Ann. ROI</th>
                                                            <th rowspan="2">After-Terms ROI Multiplier</th>
                                                        </tr>
                                                        <tr>
                                                            <th class="detail-column">Small</th>
                                                            <th>Bulk</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="scenarioDetailsBody">
                                                        <!-- Scenario details will be loaded here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="mt-3">
                                                <button id="loadScenarioBtn" class="btn btn-primary" onclick="loadScenarioToCalculator(document.getElementById('scenarioDetailName').textContent)">Load to Calculator</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Help Tab -->
                        <div class="tab-pane fade" id="help" role="tabpanel" aria-labelledby="help-tab">
                            <h4>How to Use the Multi-Product Buying Calculator</h4>
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5>How to Use</h5>
                                </div>
                                <div class="card-body">
                                    <h6><strong>Step 1: Set Parameters</strong></h6>
                                    <p>Enter your deal parameters: Deal Size (total cases), Minimum Days Stock (safety buffer), and Payment Terms (days to pay).</p>

                                    <h6><strong>Step 2: Add Products</strong></h6>
                                    <p>Click "Add Product" to add products to your analysis. Enter the product name, small deal price, bulk deal price, current inventory, annual cases sold, and bottles per case.</p>

                                    <h6><strong>Step 3: Set Allocations</strong></h6>
                                    <p><strong>Manual Entry:</strong> Enter your own bulk case quantities in the "Bulk Cases" column, then click "Calculate Results".</p>
                                    <p><strong>Auto Allocation:</strong> Click "Auto Allocation" to automatically distribute cases proportionally based on annual sales, then click "Calculate Results".</p>

                                    <h6><strong>Step 4: Optimize (Optional)</strong></h6>
                                    <p>Click "Run Optimization" to find better case distributions that maximize your portfolio ROI.</p>

                                    <h6><strong>Step 5: Save & Export</strong></h6>
                                    <p>Save your scenario for future use or export the results for analysis.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Include calculator.js -->
<script src="{{ url_for('static', filename='js/calculator.js') }}?v=1.0.1"></script>

<!-- Initialize tooltips -->
<script>
    $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>

<!-- Main application script with cache busting -->
<script src="{{ url_for('static', filename='js/multi_product_calculator_app.js') }}?v={{ range(100000, 999999) | random }}"></script>
{% endblock %}

{% block scripts %}
<!-- All scripts are included in the main block above -->
{% endblock %}
