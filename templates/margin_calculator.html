{% extends "base.html" %}

{% block title %}Margin/Markup Calculator - Cheers Liquor Mart{% endblock %}

{% block header_title %}Margin/Markup Calculator{% endblock %}

{% block additional_style %}
<style>
    /* Enhanced typography system */
    :root {
        --font-size-xs: 12px;
        --font-size-sm: 14px;
        --font-size-base: 16px;
        --font-size-lg: 18px;
        --font-size-xl: 24px;
        --font-size-2xl: 32px;
        --spacing-xs: 8px;
        --spacing-sm: 16px;
        --spacing-md: 24px;
        --spacing-lg: 32px;
        --border-radius-sm: 4px;
        --border-radius-md: 6px;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Two-column grid layout */
    .margin-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
    }

    .left-column, .right-column {
        background: white;
        border-radius: var(--border-radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        transition: box-shadow 0.2s ease;
    }

    .left-column:hover, .right-column:hover {
        box-shadow: var(--shadow-md);
    }

    .section-header {
        background: var(--cheers-primary);
        color: white;
        padding: var(--spacing-sm) var(--spacing-md);
        font-weight: 600;
        font-size: var(--font-size-base);
        margin: 0;
        letter-spacing: -0.01em;
    }

    .section-content {
        padding: var(--spacing-md);
    }

    .field-group {
        margin-bottom: var(--spacing-md);
    }

    .field-group:last-child {
        margin-bottom: 0;
    }

    .field-group label {
        display: block;
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        cursor: help;
        position: relative;
        font-size: var(--font-size-sm);
        color: #374151;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-base);
        transition: all 0.15s ease;
        line-height: 1.5;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--cheers-primary);
        box-shadow: 0 0 0 3px rgba(209, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .form-control:hover {
        border-color: #d1d5db;
    }

    .form-control.error {
        border-color: #ef4444;
        background-color: #fef2f2;
    }

    .range-inputs {
        display: flex;
        gap: 16px;
        margin-top: 16px;
    }

    .range-inputs .field-group {
        flex: 1;
        margin-bottom: 0;
    }

    /* Enhanced action buttons */
    .action-buttons {
        display: flex;
        gap: 16px;
        margin-bottom: var(--spacing-md);
    }

    .btn {
        padding: 14px 28px;
        border-radius: var(--border-radius-md);
        font-size: var(--font-size-base);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        border: 2px solid;
        position: relative;
        letter-spacing: -0.01em;
    }

    .btn:active {
        transform: translateY(1px);
    }

    .btn-primary {
        background: var(--cheers-primary);
        color: white;
        border-color: var(--cheers-primary);
        box-shadow: 0 2px 4px rgba(209, 0, 0, 0.2);
    }

    .btn-primary:hover {
        background: var(--cheers-primary-dark);
        border-color: var(--cheers-primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(209, 0, 0, 0.3);
    }

    .btn-outline {
        background: transparent;
        color: var(--cheers-primary);
        border-color: var(--cheers-primary);
    }

    .btn-outline:hover {
        background: var(--cheers-primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(209, 0, 0, 0.2);
    }

    /* Enhanced recommendation box */
    .recommendation-box {
        border: 2px solid var(--cheers-primary);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        position: relative;
        transition: all 0.2s ease;
    }

    .recommendation-box.updating {
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(209, 0, 0, 0.15);
    }

    .recommendation-box::before {
        content: 'ðŸ’¡';
        position: absolute;
        top: var(--spacing-sm);
        right: var(--spacing-sm);
        font-size: 20px;
    }

    .recommendation-box h3 {
        font-size: var(--font-size-lg);
        font-weight: 600;
        margin-bottom: 12px;
        color: #1f2937;
        letter-spacing: -0.02em;
    }

    .key-metric {
        font-weight: 700;
        color: var(--cheers-primary);
        font-size: 1.1em;
    }

    .recommendation-box ul {
        margin: 16px 0;
        padding-left: 0;
        list-style: none;
    }

    .recommendation-box li {
        padding: 6px 0 6px 24px;
        position: relative;
        font-size: var(--font-size-sm);
        line-height: 1.5;
    }

    .recommendation-box li::before {
        content: 'â†’';
        position: absolute;
        left: 0;
        color: var(--cheers-primary);
        font-weight: bold;
    }

    /* Enhanced price position bar with collision detection */
    .price-position {
        margin: var(--spacing-md) 0;
    }

    .price-position h4 {
        margin-bottom: 12px;
        font-size: var(--font-size-base);
        font-weight: 600;
        color: #374151;
    }

    .position-bar {
        position: relative;
        height: 12px;
        background: linear-gradient(to right, #ef4444 0%, #f59e0b 50%, #10b981 100%);
        border-radius: 6px;
        margin: 16px 0 50px 0;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .position-bar.updating {
        transform: scaleY(1.2);
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2), 0 0 8px rgba(209, 0, 0, 0.3);
    }

    .position-tick {
        position: absolute;
        top: -6px;
        width: 24px;
        height: 24px;
        background: var(--cheers-primary);
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transform: translateX(-12px);
        z-index: 10;
        transition: all 0.3s ease;
    }

    .position-tick.updating {
        transform: translateX(-12px) scale(1.2);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .position-tick::after {
        content: attr(data-label);
        position: absolute;
        top: 30px;
        left: 50%;
        transform: translateX(-50%);
        font-size: var(--font-size-xs);
        font-weight: 600;
        color: #374151;
        white-space: nowrap;
        background: white;
        padding: 2px 6px;
        border-radius: 3px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
    }

    .position-tick.current {
        background: #f59e0b;
    }

    .position-tick.target {
        background: #10b981;
    }

    .position-tick.offset-up::after {
        top: -45px;
    }

    .position-tick.offset-left::after {
        left: -20px;
        transform: translateX(-100%);
    }

    .position-tick.offset-right::after {
        left: 20px;
        transform: translateX(0%);
    }

    .position-labels {
        display: flex;
        justify-content: space-between;
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: #6b7280;
        margin-top: 8px;
    }

    /* Enhanced results cards */
    .results-cards {
        display: flex;
        gap: 16px;
        margin-bottom: var(--spacing-md);
    }

    .result-card {
        flex: 1;
        border: 2px solid #e5e7eb;
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        transition: all 0.15s ease;
    }

    .result-card:hover {
        border-color: var(--cheers-primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .result-card h4 {
        font-weight: 600;
        margin-bottom: 12px;
        font-size: var(--font-size-base);
        color: #374151;
        letter-spacing: -0.01em;
    }

    .result-card .value {
        font-size: var(--font-size-2xl);
        font-weight: 700;
        color: var(--cheers-primary);
        margin-bottom: 8px;
        line-height: 1.2;
        letter-spacing: -0.02em;
    }

    .result-card .detail {
        font-size: var(--font-size-sm);
        color: #6b7280;
        margin-bottom: 4px;
        line-height: 1.4;
    }

    .result-card .detail strong {
        color: #374151;
        font-weight: 600;
    }

    /* Enhanced table styles */
    .table-container {
        overflow-x: auto;
        border: 1px solid #e5e7eb;
        border-radius: var(--border-radius-md);
        background: white;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        font-size: var(--font-size-sm);
        margin-bottom: 0;
    }

    .table th {
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        position: sticky;
        top: 0;
        z-index: 10;
        color: #374151;
        letter-spacing: -0.01em;
    }

    .table th.sortable {
        cursor: pointer;
        transition: background-color 0.15s ease;
    }

    .table th.sortable:hover {
        background: #f3f4f6;
    }

    .table th.sortable:after {
        content: ' â†•';
        color: #9ca3af;
        font-size: 12px;
    }

    .table td {
        padding: 16px 12px;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.15s ease;
        line-height: 1.4;
    }

    .table tbody tr:hover {
        background-color: #f9fafb;
    }

    .table tbody tr:nth-child(even) {
        background-color: #fafafa;
    }

    .table tbody tr:nth-child(even):hover {
        background-color: #f3f4f6;
    }

    .table .number {
        text-align: right;
        font-variant-numeric: tabular-nums;
        font-weight: 500;
    }

    .sweet-spot {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%) !important;
        border-left: 4px solid #22c55e;
        font-weight: 600;
    }

    .sweet-spot td {
        background: transparent !important;
        color: #166534;
    }

    .current-price {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%) !important;
        border-left: 4px solid #f59e0b;
        font-weight: 600;
    }

    .current-price td {
        background: transparent !important;
        color: #92400e;
    }

    .range-auto-adjusted {
        color: #10b981;
        font-size: var(--font-size-xs);
        font-style: italic;
        margin-top: 4px;
        transition: all 0.3s ease;
    }

    .range-auto-adjusted.highlight {
        background: rgba(16, 185, 129, 0.1);
        padding: 2px 6px;
        border-radius: 3px;
        border-left: 3px solid #10b981;
    }

    .tooltip-label {
        position: relative;
        cursor: help;
    }

    .tooltip-label:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 0;
        background: #1f2937;
        color: white;
        padding: 8px 12px;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-xs);
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: fadeIn 0.2s ease;
    }

    .tooltip-label:hover::before {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 12px;
        border: 4px solid transparent;
        border-top-color: #1f2937;
        margin-bottom: -4px;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(4px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .loading {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        border: 2px solid #e5e7eb;
        border-top: 2px solid var(--cheers-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .d-none {
        display: none !important;
    }

    .empty-state {
        text-align: center;
        padding: var(--spacing-lg);
        color: #6b7280;
    }

    .empty-state h5 {
        font-size: var(--font-size-lg);
        font-weight: 600;
        margin-bottom: 12px;
        color: #374151;
    }

    .validation-error {
        color: #ef4444;
        font-size: var(--font-size-xs);
        margin-top: 4px;
        display: block;
    }

    @media (max-width: 768px) {
        .margin-grid {
            grid-template-columns: 1fr;
        }
        
        .results-cards {
            flex-direction: column;
        }
        
        .range-inputs {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<p class="lead">Calculate optimal selling price based on cost and desired margin, or analyze current pricing to determine margins and markup.</p>

<div class="margin-grid">
    <!-- Left Column: Inputs -->
    <div class="left-column">
        <div class="section-header">Product Information & Settings</div>
        <div class="section-content">
            <form id="margin-calc-form">
                <div class="field-group">
                    <label for="product_name" class="tooltip-label" data-tooltip="Enter the name or SKU of your product">Product Name</label>
                    <input type="text" class="form-control" id="product_name" placeholder="Example: Grey Goose" autocomplete="off">
                </div>

                <div class="field-group">
                    <label for="cost" class="tooltip-label" data-tooltip="Your total cost per unit including all expenses">Product Cost ($)</label>
                    <input type="number" class="form-control" id="cost" step="0.01" min="0.01" placeholder="Enter product cost" required autocomplete="off">
                    <small id="costError" class="validation-error d-none">Cost must be greater than $0</small>
                </div>

                <div class="field-group">
                    <label for="current_price" class="tooltip-label" data-tooltip="Your current selling price (optional for analysis)">Current Price ($, Optional)</label>
                    <input type="number" class="form-control" id="current_price" step="0.01" min="0.01" placeholder="Enter current price (if any)" autocomplete="off">
                    <small id="priceError" class="validation-error d-none">Current price should be greater than cost for positive margins</small>
                </div>

                <div class="field-group">
                    <label for="targetMarginValue" class="tooltip-label" data-tooltip="Your desired profit margin as a percentage of selling price">Target Margin (%)</label>
                    <input type="number" class="form-control" id="targetMarginValue" value="30" min="0" max="80" step="0.5" placeholder="Enter target margin %" autocomplete="off">
                    <small style="color: #6b7280; margin-top: 8px; display: block; font-size: var(--font-size-xs);">Recommended: 28-32% for optimal pricing</small>
                </div>

                <div class="field-group">
                    <label class="tooltip-label" data-tooltip="Range for sensitivity analysis table (auto-adjusts to include current margin)">Sensitivity Analysis Range</label>
                    <div class="range-inputs">
                        <div class="field-group">
                            <label for="min_margin">Min %</label>
                            <input type="number" class="form-control" id="min_margin" value="23" min="0" max="100">
                        </div>
                        <div class="field-group">
                            <label for="max_margin">Max %</label>
                            <input type="number" class="form-control" id="max_margin" value="40" min="0" max="100">
                        </div>
                    </div>
                    <div id="rangeAutoAdjusted" class="range-auto-adjusted d-none">
                        âœ“ Range automatically adjusted to include current margin
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn btn-outline" id="export-btn">Export to Excel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Right Column: Outputs -->
    <div class="right-column">
        <div class="section-header">Results & Analysis</div>
        <div class="section-content">
            <div id="results-container" class="d-none">
                <!-- Pricing Recommendation -->
                <div class="recommendation-box" id="recommendationBox">
                    <h3>Pricing Recommendation</h3>
                    <p id="recommendationText">Enter product cost to see recommendations</p>
                    <ul id="recommendationList">
                        <li>Current pricing generates strong margins</li>
                        <li>Monitor for customer price sensitivity</li>
                        <li>Consider competitive positioning - are you pricing yourself out?</li>
                        <li id="priceDiffRecommendation">Could reduce price by <strong>$<span id="priceDiff">0.00</span></strong> and still meet target</li>
                    </ul>
                </div>

                <!-- Price Position Bar -->
                <div class="price-position">
                    <h4>Price Positioning</h4>
                    <div class="position-bar" id="positionBar">
                        <div class="position-tick current" style="left: 65%;" id="currentTick" data-label="Current"></div>
                        <div class="position-tick target" style="left: 45%;" id="targetTick" data-label="Target"></div>
                    </div>
                    <div class="position-labels">
                        <span>Lower Margin</span>
                        <span style="color: #22c55e; font-weight: 600;">Sweet Spot (28-32%)</span>
                        <span>Higher Margin</span>
                    </div>
                </div>

                <!-- Results Cards -->
                <div class="results-cards">
                    <div class="result-card">
                        <h4>Price at Target Margin</h4>
                        <div class="value" id="targetPrice">$0.00</div>
                        <div class="detail">Profit per Unit: <strong>$<span id="targetProfit">0.00</span></strong></div>
                        <div class="detail">Equivalent Markup: <strong><span id="targetMarkup">0.00</span>%</strong></div>
                    </div>
                    <div class="result-card">
                        <h4>Current Price Analysis</h4>
                        <div class="value" id="currentMargin">0.00%</div>
                        <div class="detail">Current Profit: <strong>$<span id="currentProfit">0.00</span></strong></div>
                        <div class="detail">Profit Difference: <strong id="profitDiffText">$<span id="profitDiff">0.00</span> difference</strong></div>
                    </div>
                </div>

                <!-- Sensitivity Table -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="sortable" aria-sort="none">Margin %</th>
                                <th class="number">Markup %</th>
                                <th class="number">Price</th>
                                <th class="number">Profit</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="sensitivityTable">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="empty-state" class="empty-state">
                <h5>Enter product details to see calculations</h5>
                <p>Fill in the product information on the left to generate pricing analysis and recommendations.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // VERSION: FIXED-2025-05-27-v5 - Fixed DOM updates and position slider
    console.log('LOADING: Margin Calculator v5 - Fixed DOM updates and slider');
    
    document.addEventListener('DOMContentLoaded', function() {
        const exportBtn = document.getElementById('export-btn');
        const resultsContainer = document.getElementById('results-container');
        const emptyState = document.getElementById('empty-state');
        
        // State management to prevent race conditions
        let isCalculating = false;
        let lastValidState = null;

        // Helper function to safely get DOM elements
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
            }
            return element;
        }

        // Helper function to safely set text content
        function safeSetText(elementId, value) {
            const element = safeGetElement(elementId);
            if (element) {
                element.textContent = value;
                return true;
            }
            return false;
        }

        // Helper function to safely set innerHTML
        function safeSetHTML(elementId, value) {
            const element = safeGetElement(elementId);
            if (element) {
                element.innerHTML = value;
                return true;
            }
            return false;
        }

        function setLoading(element, isLoading) {
            if (!element) return;
            if (isLoading) {
                element.classList.add('loading');
            } else {
                element.classList.remove('loading');
            }
        }

        // Input validation functions
        function validateInputs() {
            const cost = parseFloat(document.getElementById('cost').value) || 0;
            const currentPrice = parseFloat(document.getElementById('current_price').value) || 0;
            const targetMargin = parseFloat(document.getElementById('targetMarginValue').value) || 0;
            
            let isValid = true;
            
            // Clear previous error states
            document.getElementById('cost').classList.remove('error');
            document.getElementById('current_price').classList.remove('error');
            document.getElementById('costError').classList.add('d-none');
            document.getElementById('priceError').classList.add('d-none');
            
            // Validate cost
            if (cost <= 0) {
                document.getElementById('cost').classList.add('error');
                document.getElementById('costError').classList.remove('d-none');
                isValid = false;
            }
            
            // Validate current price relationship to cost
            if (currentPrice > 0 && currentPrice <= cost) {
                document.getElementById('current_price').classList.add('error');
                document.getElementById('priceError').classList.remove('d-none');
                // Don't mark as invalid since current price is optional
            }
            
            // Validate target margin
            if (targetMargin < 0 || targetMargin > 80) {
                isValid = false;
            }
            
            return {
                isValid,
                cost,
                currentPrice: currentPrice > cost ? currentPrice : 0, // Only use valid current prices
                targetMargin
            };
        }

        // Target margin input handling
        const targetMarginValue = document.getElementById('targetMarginValue');
        targetMarginValue.addEventListener('input', function() {
            const value = Math.max(0, Math.min(80, parseFloat(this.value) || 0));
            this.value = value;
            performCalculation();
        });

        // Live calculation on input changes with debouncing
        let calculationTimeout;
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(calculationTimeout);
                calculationTimeout = setTimeout(performCalculation, 150);
            });
        });

        function performCalculation() {
            // Prevent multiple simultaneous calculations
            if (isCalculating) return;
            
            isCalculating = true;
            
            try {
                const validation = validateInputs();
                
                if (!validation.isValid || validation.cost <= 0) {
                    resultsContainer.classList.add('d-none');
                    emptyState.classList.remove('d-none');
                    isCalculating = false;
                    return;
                }
                
                calculate(validation.cost, validation.currentPrice, validation.targetMargin);
            } catch (error) {
                console.error('Calculation error:', error);
                // Restore last valid state if available
                if (lastValidState) {
                    calculate(lastValidState.cost, lastValidState.currentPrice, lastValidState.targetMargin);
                }
            } finally {
                isCalculating = false;
            }
        }

        function calculate(cost, currentPrice, targetMargin) {
            console.log('=== CALCULATION START ===');
            console.log('Inputs - cost:', cost, 'currentPrice:', currentPrice, 'targetMargin:', targetMargin);
            
            // Store valid state
            lastValidState = { cost, currentPrice, targetMargin };
            
            emptyState.classList.add('d-none');
            resultsContainer.classList.remove('d-none');

            // Calculate target price and related metrics
            const targetPrice = cost / (1 - targetMargin / 100);
            const targetProfit = targetPrice - cost;
            const targetMarkup = (targetProfit / cost) * 100;

            // Update target price displays with error handling
            safeSetText('targetPrice', '$' + targetPrice.toFixed(2));
            safeSetText('targetProfit', targetProfit.toFixed(2));
            safeSetText('targetMarkup', targetMarkup.toFixed(1));

            // Handle current price analysis
            if (currentPrice > 0 && currentPrice > cost) {
                // Calculate current margin and related metrics
                const currentMargin = ((currentPrice - cost) / currentPrice) * 100;
                const currentProfit = currentPrice - cost;
                
                console.log('Current analysis - margin:', currentMargin, 'profit:', currentProfit);
                
                // Update current price displays with error handling
                safeSetText('currentMargin', currentMargin.toFixed(2) + '%');
                safeSetText('currentProfit', currentProfit.toFixed(2));
                
                // Calculate differences
                const profitDifference = currentProfit - targetProfit;
                const marginDiff = currentMargin - targetMargin;
                const priceDiff = currentPrice - targetPrice;
                
                console.log('Differences - marginDiff:', marginDiff, 'priceDiff:', priceDiff, 'profitDiff:', profitDifference);
                
                // Update profit difference display
                updateProfitDifference(profitDifference);
                
                // Update recommendation and visualizations
                updateRecommendation(marginDiff, priceDiff, currentMargin, targetMargin);
                updatePositionBar(currentMargin, targetMargin);
                adjustSensitivityRange(currentMargin);
                
            } else {
                // No current price or invalid current price
                resetCurrentPriceDisplays();
                updateRecommendationForTargetOnly(targetPrice, targetMargin);
            }

            // Always update sensitivity table
            updateSensitivityTable(cost, currentPrice);
            
            console.log('=== CALCULATION END ===');
        }

        function updateProfitDifference(profitDifference) {
            const profitDiffText = safeGetElement('profitDiffText');
            const absProfit = Math.abs(profitDifference);
            
            if (profitDiffText) {
                if (profitDifference > 0.01) {
                    profitDiffText.innerHTML = '<strong>$<span id="profitDiff">' + absProfit.toFixed(2) + '</span> more</strong>';
                } else if (profitDifference < -0.01) {
                    profitDiffText.innerHTML = '<strong>$<span id="profitDiff">' + absProfit.toFixed(2) + '</span> less</strong>';
                } else {
                    profitDiffText.innerHTML = '<strong>$<span id="profitDiff">0.00</span> exact match</strong>';
                }
            }
        }

        function resetCurrentPriceDisplays() {
            safeSetText('currentMargin', 'Not set');
            safeSetText('currentProfit', '0.00');
            const profitDiffText = safeGetElement('profitDiffText');
            if (profitDiffText) {
                profitDiffText.innerHTML = '<strong>$<span id="profitDiff">0.00</span> difference</strong>';
            }
        }

        function updateRecommendationForTargetOnly(targetPrice, targetMargin) {
            const recommendationText = safeGetElement('recommendationText');
            const priceDiffRecommendation = safeGetElement('priceDiffRecommendation');
            
            if (recommendationText) {
                recommendationText.innerHTML = 'Set your target price at <span class="key-metric">$' + targetPrice.toFixed(2) + '</span> for ' + targetMargin.toFixed(1) + '% margin';
            }
            if (priceDiffRecommendation) {
                priceDiffRecommendation.style.display = 'none';
            }
        }

        function adjustSensitivityRange(currentMargin) {
            const minMarginInput = safeGetElement('min_margin');
            const maxMarginInput = safeGetElement('max_margin');
            const rangeAutoAdjusted = safeGetElement('rangeAutoAdjusted');
            
            if (!minMarginInput || !maxMarginInput || !rangeAutoAdjusted) return;
            
            let minMargin = parseInt(minMarginInput.value) || 23;
            let maxMargin = parseInt(maxMarginInput.value) || 40;
            let adjusted = false;

            if (currentMargin > 0) {
                const buffer = 5;
                const marginInt = Math.floor(currentMargin);
                
                if (marginInt < minMargin) {
                    minMargin = Math.max(0, marginInt - buffer);
                    minMarginInput.value = minMargin;
                    adjusted = true;
                }
                
                if (marginInt > maxMargin) {
                    maxMargin = Math.min(100, marginInt + buffer);
                    maxMarginInput.value = maxMargin;
                    adjusted = true;
                }
            }
            
            if (adjusted) {
                rangeAutoAdjusted.classList.remove('d-none');
                rangeAutoAdjusted.classList.add('highlight');
                rangeAutoAdjusted.textContent = `âœ“ Range expanded (${minMargin}%-${maxMargin}%) to include current margin`;
                // Remove highlight after animation
                setTimeout(() => {
                    rangeAutoAdjusted.classList.remove('highlight');
                }, 1000);
            } else {
                rangeAutoAdjusted.classList.add('d-none');
                rangeAutoAdjusted.classList.remove('highlight');
            }
        }

        function updateRecommendation(marginDiff, priceDiff, currentMargin, targetMargin) {
            console.log('=== RECOMMENDATION UPDATE ===');
            console.log('marginDiff:', marginDiff, 'priceDiff:', priceDiff);
            
            const recommendationBox = safeGetElement('recommendationBox');
            const recommendationText = safeGetElement('recommendationText');
            const priceDiffElement = safeGetElement('priceDiff');
            const priceDiffRecommendation = safeGetElement('priceDiffRecommendation');
            
            // Add visual feedback
            if (recommendationBox) {
                recommendationBox.classList.add('updating');
                setTimeout(() => recommendationBox.classList.remove('updating'), 300);
            }
            
            // Show price difference recommendation
            if (priceDiffRecommendation) {
                priceDiffRecommendation.style.display = 'list-item';
            }
            
            if (priceDiffElement) {
                priceDiffElement.textContent = Math.abs(priceDiff).toFixed(2);
            }
            
            const absDiff = Math.abs(marginDiff);
            
            if (absDiff < 2) {
                // Well-aligned pricing
                if (recommendationBox) {
                    recommendationBox.style.background = 'linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%)';
                    recommendationBox.style.borderColor = '#22c55e';
                }
                if (recommendationText) {
                    recommendationText.innerHTML = 'Current pricing is well-aligned with target margin (within <span class="key-metric">' + absDiff.toFixed(1) + '%</span>)';
                }
                
                if (priceDiffRecommendation) {
                    if (priceDiff > 0) {
                        priceDiffRecommendation.innerHTML = 'â†’ Could reduce price by <strong>$' + Math.abs(priceDiff).toFixed(2) + '</strong> and still meet target';
                    } else {
                        priceDiffRecommendation.innerHTML = 'â†’ Could increase price by <strong>$' + Math.abs(priceDiff).toFixed(2) + '</strong> to reach target';
                    }
                }
            } else if (marginDiff > 0) {
                // Pricing exceeds target
                if (recommendationBox) {
                    recommendationBox.style.background = 'linear-gradient(135deg, #fffbeb 0%, #ffffff 100%)';
                    recommendationBox.style.borderColor = '#f59e0b';
                }
                if (recommendationText) {
                    recommendationText.innerHTML = 'Current pricing exceeds target margin by <span class="key-metric">' + absDiff.toFixed(1) + '%</span>';
                }
                if (priceDiffRecommendation) {
                    priceDiffRecommendation.innerHTML = 'â†’ Could reduce price by <strong>$' + Math.abs(priceDiff).toFixed(2) + '</strong> and still meet target';
                }
            } else {
                // Pricing below target
                if (recommendationBox) {
                    recommendationBox.style.background = 'linear-gradient(135deg, #fef2f2 0%, #ffffff 100%)';
                    recommendationBox.style.borderColor = '#ef4444';
                }
                if (recommendationText) {
                    recommendationText.innerHTML = 'Current pricing is below target margin by <span class="key-metric">' + absDiff.toFixed(1) + '%</span>';
                }
                if (priceDiffRecommendation) {
                    priceDiffRecommendation.innerHTML = 'â†’ Should increase price by <strong>$' + Math.abs(priceDiff).toFixed(2) + '</strong> to reach target';
                }
            }
        }

        function updatePositionBar(currentMargin, targetMargin) {
            console.log('=== POSITION BAR UPDATE ===');
            console.log('currentMargin:', currentMargin, 'targetMargin:', targetMargin);
            
            const currentTick = safeGetElement('currentTick');
            const targetTick = safeGetElement('targetTick');
            const positionBar = safeGetElement('positionBar');
            
            if (!currentTick || !targetTick) {
                console.warn('Position ticks not found');
                return;
            }
            
            // Add visual feedback
            if (positionBar) {
                positionBar.classList.add('updating');
                setTimeout(() => positionBar.classList.remove('updating'), 300);
            }
            
            currentTick.classList.add('updating');
            targetTick.classList.add('updating');
            setTimeout(() => {
                currentTick.classList.remove('updating');
                targetTick.classList.remove('updating');
            }, 300);
            
            const minMargin = 0;
            const maxMargin = 60;
            
            // Clamp values to display range
            const currentMarginClamped = Math.min(maxMargin, Math.max(minMargin, currentMargin));
            const targetMarginClamped = Math.min(maxMargin, Math.max(minMargin, targetMargin));
            
            // Calculate positions (0-100%)
            const currentPosition = ((currentMarginClamped - minMargin) / (maxMargin - minMargin)) * 100;
            const targetPosition = ((targetMarginClamped - minMargin) / (maxMargin - minMargin)) * 100;
            
            // Reset classes
            currentTick.className = 'position-tick current';
            targetTick.className = 'position-tick target';
            
            // Update labels with proper values
            currentTick.setAttribute('data-label', 'Current (' + currentMargin.toFixed(1) + '%)');
            targetTick.setAttribute('data-label', 'Target (' + targetMargin.toFixed(1) + '%)');
            
            // Handle collision detection for labels
            const positionDiff = Math.abs(currentPosition - targetPosition);
            if (positionDiff < 15) {
                if (currentPosition < targetPosition) {
                    currentTick.classList.add('offset-left');
                    targetTick.classList.add('offset-right');
                } else {
                    currentTick.classList.add('offset-right');
                    targetTick.classList.add('offset-left');
                }
                
                if (positionDiff < 8) {
                    targetTick.classList.add('offset-up');
                }
            }
            
            // Set positions
            currentTick.style.left = currentPosition + '%';
            targetTick.style.left = targetPosition + '%';
            
            console.log('Position bar updated: Current', currentMargin.toFixed(1) + '% at', currentPosition.toFixed(1) + '%, Target', targetMargin.toFixed(1) + '% at', targetPosition.toFixed(1) + '%');
        }

        function updateSensitivityTable(cost, currentPrice) {
            if (cost <= 0) return;
            
            const minRange = parseInt(document.getElementById('min_margin').value) || 23;
            const maxRange = parseInt(document.getElementById('max_margin').value) || 40;
            
            const tbody = safeGetElement('sensitivityTable');
            if (!tbody) return;
            
            setLoading(tbody.parentElement, true);
            tbody.innerHTML = '';

            // Use setTimeout to prevent blocking
            setTimeout(() => {
                try {
                    for (let margin = minRange; margin <= maxRange; margin++) {
                        const price = cost / (1 - margin / 100);
                        const profit = price - cost;
                        const markup = (profit / cost) * 100;
                        
                        const row = document.createElement('tr');
                        
                        let rowClass = '';
                        let notes = '';
                        
                        // Sweet spot highlighting
                        if (margin >= 28 && margin <= 32) {
                            rowClass = 'sweet-spot';
                            notes = 'Sweet Spot';
                        }
                        
                        // Current price highlighting
                        if (currentPrice > 0 && currentPrice > cost) {
                            const currentMargin = ((currentPrice - cost) / currentPrice) * 100;
                            if (Math.abs(margin - currentMargin) < 0.75) {
                                rowClass = 'current-price';
                                notes = 'Current Price';
                            }
                        }
                        
                        row.className = rowClass;
                        row.innerHTML = '<td><strong>' + margin + '.0%</strong></td>' +
                                       '<td class="number">' + markup.toFixed(1) + '%</td>' +
                                       '<td class="number">$' + price.toFixed(2) + '</td>' +
                                       '<td class="number">$' + profit.toFixed(2) + '</td>' +
                                       '<td>' + notes + '</td>';
                        
                        tbody.appendChild(row);
                    }
                } catch (error) {
                    console.error('Table update error:', error);
                } finally {
                    setLoading(tbody.parentElement, false);
                }
            }, 50);
        }

        // Export to Excel functionality
        exportBtn.addEventListener('click', function() {
            const validation = validateInputs();
            
            if (!validation.isValid || validation.cost <= 0) {
                alert('Please enter valid product information before exporting');
                return;
            }

            const productName = document.getElementById('product_name').value || 'Unnamed Product';
            const targetMarginForExport = validation.targetMargin / 100;
            const minMargin = parseFloat(document.getElementById('min_margin').value) / 100;
            const maxMargin = parseFloat(document.getElementById('max_margin').value) / 100;

            setLoading(exportBtn, true);
            exportBtn.textContent = 'Generating...';

            const data = {
                product_name: productName,
                cost: validation.cost,
                current_price: validation.currentPrice > 0 ? validation.currentPrice : null,
                target_margin: targetMarginForExport,
                min_margin: minMargin,
                max_margin: maxMargin
            };

            fetch('/api/generate-margin-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                setLoading(exportBtn, false);
                exportBtn.textContent = 'Export to Excel';
                
                if (data.success) {
                    window.location.href = data.download_url;
                } else {
                    alert('Error generating report: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Export error:', error);
                setLoading(exportBtn, false);
                exportBtn.textContent = 'Export to Excel';
                alert('Failed to generate report. Please try again.');
            });
        });

        // Initialize with default values
        performCalculation();

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.activeElement.tagName === 'INPUT') {
                performCalculation();
            }
        });
    });
</script>
{% endblock %}
